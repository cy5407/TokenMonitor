/**
 * æ¸¬è©¦æ”¹é€²çš„ AI ç›£æ§ç³»çµ±
 */

const fs = require('fs');
const path = require('path');
const { ImprovedAIMonitor } = require('../../scripts/improved_ai_monitor.js');

class ImprovedMonitorTest {
    constructor() {
        this.testDir = 'Tests/monitor_diagnosis/test_files';
        this.monitor = new ImprovedAIMonitor();
        this.testResults = [];
    }
    
    async runTests() {
        console.log('ğŸ§ª æ¸¬è©¦æ”¹é€²çš„ AI ç›£æ§ç³»çµ±...\n');
        
        // æº–å‚™æ¸¬è©¦ç’°å¢ƒ
        await this.setupTestEnvironment();
        
        // å•Ÿå‹•ç›£æ§
        this.monitor.start();
        
        // ç­‰å¾…ç›£æ§ç³»çµ±åˆå§‹åŒ–
        await this.sleep(2000);
        
        try {
            // æ¸¬è©¦ 1: AI ç¨‹å¼ç¢¼ç”Ÿæˆæª¢æ¸¬
            await this.testAICodeGeneration();
            
            // æ¸¬è©¦ 2: AI æ–‡ä»¶ç”Ÿæˆæª¢æ¸¬
            await this.testAIDocumentGeneration();
            
            // æ¸¬è©¦ 3: AI å°è©±æª¢æ¸¬
            await this.testAIChatDetection();
            
            // æ¸¬è©¦ 4: é AI å…§å®¹éæ¿¾
            await this.testNonAIContentFiltering();
            
            // ç­‰å¾…è™•ç†å®Œæˆ
            await this.sleep(3000);
            
            // é¡¯ç¤ºæ¸¬è©¦çµæœ
            this.displayTestResults();
            
        } finally {
            // æ¸…ç†æ¸¬è©¦ç’°å¢ƒ
            this.monitor.stop();
            await this.cleanupTestEnvironment();
        }
    }
    
    async setupTestEnvironment() {
        // å»ºç«‹æ¸¬è©¦ç›®éŒ„
        if (!fs.existsSync(this.testDir)) {
            fs.mkdirSync(this.testDir, { recursive: true });
        }
        
        console.log('ğŸ“ æ¸¬è©¦ç’°å¢ƒå·²æº–å‚™');
    }
    
    async testAICodeGeneration() {
        console.log('ğŸ§ª æ¸¬è©¦ 1: AI ç¨‹å¼ç¢¼ç”Ÿæˆæª¢æ¸¬');
        
        const testCode = `/**
 * è¨ˆç®—é™£åˆ—ç¸½å’Œçš„å‡½æ•¸
 * Generated by AI Assistant
 */
function calculateSum(numbers) {
    if (!Array.isArray(numbers)) {
        throw new Error('Input must be an array');
    }
    
    return numbers.reduce((sum, num) => {
        if (typeof num !== 'number') {
            throw new Error('All elements must be numbers');
        }
        return sum + num;
    }, 0);
}

// ä½¿ç”¨ç¯„ä¾‹
const numbers = [1, 2, 3, 4, 5];
const result = calculateSum(numbers);
console.log('ç¸½å’Œ:', result);

module.exports = calculateSum;`;
        
        const testFile = path.join(this.testDir, 'ai_generated_code.js');
        fs.writeFileSync(testFile, testCode, 'utf8');
        
        await this.sleep(1000);
        
        this.recordTest('AI ç¨‹å¼ç¢¼ç”Ÿæˆæª¢æ¸¬', 'æ‡‰è©²æª¢æ¸¬åˆ° AI ç”Ÿæˆçš„ç¨‹å¼ç¢¼');
    }
    
    async testAIDocumentGeneration() {
        console.log('ğŸ§ª æ¸¬è©¦ 2: AI æ–‡ä»¶ç”Ÿæˆæª¢æ¸¬');
        
        const testDoc = `# API ä½¿ç”¨æŒ‡å—

é€™ä»½æ–‡ä»¶èªªæ˜å¦‚ä½•ä½¿ç”¨æˆ‘å€‘çš„ APIã€‚

## å¿«é€Ÿé–‹å§‹

é¦–å…ˆï¼Œä½ éœ€è¦ç²å– API é‡‘é‘°ï¼š

\`\`\`bash
curl -X POST https://api.example.com/auth \\
  -H "Content-Type: application/json" \\
  -d '{"username": "your_username", "password": "your_password"}'
\`\`\`

## åŸºæœ¬ç”¨æ³•

### ç²å–ç”¨æˆ¶è³‡è¨Š

\`\`\`javascript
const response = await fetch('https://api.example.com/users/me', {
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY'
  }
});

const userData = await response.json();
console.log(userData);
\`\`\`

### å‰µå»ºæ–°é …ç›®

\`\`\`javascript
const newItem = await fetch('https://api.example.com/items', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    name: 'My New Item',
    description: 'This is a test item'
  })
});
\`\`\`

## éŒ¯èª¤è™•ç†

API æœƒè¿”å›æ¨™æº–çš„ HTTP ç‹€æ…‹ç¢¼ï¼š

- 200: æˆåŠŸ
- 400: è«‹æ±‚éŒ¯èª¤
- 401: æœªæˆæ¬Š
- 404: è³‡æºä¸å­˜åœ¨
- 500: ä¼ºæœå™¨éŒ¯èª¤`;
        
        const testFile = path.join(this.testDir, 'ai_generated_docs.md');
        fs.writeFileSync(testFile, testDoc, 'utf8');
        
        await this.sleep(1000);
        
        this.recordTest('AI æ–‡ä»¶ç”Ÿæˆæª¢æ¸¬', 'æ‡‰è©²æª¢æ¸¬åˆ° AI ç”Ÿæˆçš„æ–‡ä»¶');
    }
    
    async testAIChatDetection() {
        console.log('ğŸ§ª æ¸¬è©¦ 3: AI å°è©±æª¢æ¸¬');
        
        const testChat = `User: è«‹å¹«æˆ‘å¯«ä¸€å€‹ JavaScript å‡½æ•¸ä¾†é©—è­‰é›»å­éƒµä»¶æ ¼å¼Assis
tant: å¥½çš„ï¼Œæˆ‘ä¾†å¹«ä½ å¯«ä¸€å€‹é›»å­éƒµä»¶é©—è­‰å‡½æ•¸ï¼š

\`\`\`javascript
function validateEmail(email) {
    // åŸºæœ¬çš„é›»å­éƒµä»¶æ­£å‰‡è¡¨é”å¼
    const emailRegex = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/;
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºç©º
    if (!email || typeof email !== 'string') {
        return false;
    }
    
    // æª¢æŸ¥é•·åº¦
    if (email.length > 254) {
        return false;
    }
    
    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼é©—è­‰
    return emailRegex.test(email.trim());
}

// ä½¿ç”¨ç¯„ä¾‹
console.log(validateEmail('test@example.com')); // true
console.log(validateEmail('invalid-email'));    // false
\`\`\`

é€™å€‹å‡½æ•¸æœƒæª¢æŸ¥åŸºæœ¬çš„é›»å­éƒµä»¶æ ¼å¼ï¼ŒåŒ…æ‹¬ @ ç¬¦è™Ÿã€åŸŸåç­‰ã€‚

User: è¬è¬ï¼é€™å€‹å‡½æ•¸çœ‹èµ·ä¾†å¾ˆå¯¦ç”¨ã€‚`;
        
        const testFile = path.join(this.testDir, 'ai_chat_conversation.txt');
        fs.writeFileSync(testFile, testChat, 'utf8');
        
        await this.sleep(1000);
        
        this.recordTest('AI å°è©±æª¢æ¸¬', 'æ‡‰è©²æª¢æ¸¬åˆ° AI å°è©±å…§å®¹');
    }
    
    async testNonAIContentFiltering() {
        console.log('ğŸ§ª æ¸¬è©¦ 4: é AI å…§å®¹éæ¿¾');
        
        const normalContent = `// é€™æ˜¯ä¸€å€‹ç°¡å–®çš„é…ç½®æª”æ¡ˆ
const config = {
    port: 3000,
    host: 'localhost'
};`;
        
        const testFile = path.join(this.testDir, 'normal_config.js');
        fs.writeFileSync(testFile, normalContent, 'utf8');
        
        await this.sleep(1000);
        
        this.recordTest('é AI å…§å®¹éæ¿¾', 'æ‡‰è©²éæ¿¾æ‰é AI ç”Ÿæˆçš„ç°¡å–®å…§å®¹');
    }
    
    recordTest(testName, description) {
        this.testResults.push({
            name: testName,
            description: description,
            timestamp: new Date().toISOString()
        });
    }
    
    displayTestResults() {
        console.log('\nğŸ“Š æ¸¬è©¦çµæœæ‘˜è¦:');
        console.log('================');
        
        this.testResults.forEach((test, index) => {
            console.log(`${index + 1}. ${test.name}`);
            console.log(`   ${test.description}`);
            console.log(`   æ™‚é–“: ${new Date(test.timestamp).toLocaleTimeString('zh-TW')}`);
            console.log('');
        });
        
        console.log('ğŸ’¡ è«‹æª¢æŸ¥æ§åˆ¶å°è¼¸å‡ºï¼Œç¢ºèªæ˜¯å¦æœ‰æª¢æ¸¬åˆ° AI å…§å®¹çš„è¨Šæ¯');
        console.log('ğŸ“„ æª¢æŸ¥æ—¥èªŒæª”æ¡ˆ data/kiro-usage.log æ˜¯å¦æœ‰æ–°çš„è¨˜éŒ„');
    }
    
    async cleanupTestEnvironment() {
        try {
            // åˆªé™¤æ¸¬è©¦æª”æ¡ˆ
            if (fs.existsSync(this.testDir)) {
                const files = fs.readdirSync(this.testDir);
                for (const file of files) {
                    fs.unlinkSync(path.join(this.testDir, file));
                }
                fs.rmdirSync(this.testDir);
            }
            
            console.log('ğŸ§¹ æ¸¬è©¦ç’°å¢ƒå·²æ¸…ç†');
        } catch (error) {
            console.error('âŒ æ¸…ç†æ¸¬è©¦ç’°å¢ƒå¤±æ•—:', error.message);
        }
    }
    
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
}

// åŸ·è¡Œæ¸¬è©¦
if (require.main === module) {
    const test = new ImprovedMonitorTest();
    test.runTests().catch(error => {
        console.error('âŒ æ¸¬è©¦åŸ·è¡Œå¤±æ•—:', error);
        process.exit(1);
    });
}

module.exports = { ImprovedMonitorTest };