/**
 * æ‰‹å‹•æ¸¬è©¦ AI å…§å®¹æª¢æ¸¬
 */

const fs = require('fs');
const path = require('path');

// æ¸¬è©¦ AI å…§å®¹æª¢æ¸¬é‚è¼¯
function testAIDetection() {
    console.log('ğŸ§ª æ‰‹å‹•æ¸¬è©¦ AI å…§å®¹æª¢æ¸¬é‚è¼¯...\n');
    
    // AI æª¢æ¸¬æ¨¡å¼
    const aiPatterns = [
        /function\s+\w+\s*\([^)]*\)\s*{[\s\S]*}/,
        /class\s+\w+\s*{[\s\S]*}/,
        /const\s+\w+\s*=\s*\([^)]*\)\s*=>/,
        /```[\s\S]*?```/,
        /\/\*\*[\s\S]*?\*\//,
        /\/\/\s*(Generated|Created|AI|Assistant)/i,
        /#{1,6}\s+.+/,
        /^\s*-\s+.+/m,
        /^(User|Assistant|AI):/m,
        /^Q:|^A:/m
    ];
    
    // æ¸¬è©¦å…§å®¹
    const testCases = [
        {
            name: 'AI ç”Ÿæˆçš„å‡½æ•¸',
            content: `/**
 * è¨ˆç®—é™£åˆ—ç¸½å’Œçš„å‡½æ•¸
 * Generated by AI Assistant
 */
function calculateSum(numbers) {
    return numbers.reduce((sum, num) => sum + num, 0);
}`
        },
        {
            name: 'Markdown æ–‡ä»¶',
            content: `# API ä½¿ç”¨æŒ‡å—

é€™ä»½æ–‡ä»¶èªªæ˜å¦‚ä½•ä½¿ç”¨æˆ‘å€‘çš„ APIã€‚

\`\`\`javascript
const response = await fetch('/api/users');
\`\`\`

## åŸºæœ¬ç”¨æ³•

- ç²å–ç”¨æˆ¶è³‡è¨Š
- å‰µå»ºæ–°é …ç›®`
        },
        {
            name: 'AI å°è©±',
            content: `User: è«‹å¹«æˆ‘å¯«ä¸€å€‹å‡½æ•¸Assista
nt: å¥½çš„ï¼Œæˆ‘ä¾†å¹«ä½ å¯«ä¸€å€‹å‡½æ•¸ï¼š

\`\`\`javascript
function example() {
    return "Hello World";
}
\`\`\`

é€™å€‹å‡½æ•¸æœƒè¿”å›ä¸€å€‹å­—ç¬¦ä¸²ã€‚`
        },
        {
            name: 'æ™®é€šé…ç½®æª”æ¡ˆ',
            content: `const config = {
    port: 3000,
    host: 'localhost'
};`
        }
    ];
    
    function isAIGeneratedContent(content) {
        let score = 0;
        
        for (const pattern of aiPatterns) {
            if (pattern.test(content)) {
                score++;
                console.log(`  âœ… ç¬¦åˆæ¨¡å¼: ${pattern}`);
            }
        }
        
        // é¡å¤–æª¢æŸ¥
        if (content.length > 100 && content.includes('function')) {
            score++;
            console.log(`  âœ… é•·å…§å®¹åŒ…å« function`);
        }
        if (content.includes('```') && content.includes('javascript')) {
            score++;
            console.log(`  âœ… åŒ…å« JavaScript ç¨‹å¼ç¢¼å€å¡Š`);
        }
        if (content.includes('# ') && content.length > 50) {
            score++;
            console.log(`  âœ… åŒ…å« Markdown æ¨™é¡Œ`);
        }
        
        console.log(`  ğŸ“Š ç¸½åˆ†: ${score}`);
        return score >= 2;
    }
    
    // æ¸¬è©¦æ¯å€‹æ¡ˆä¾‹
    testCases.forEach((testCase, index) => {
        console.log(`\n${index + 1}. æ¸¬è©¦: ${testCase.name}`);
        console.log(`å…§å®¹é•·åº¦: ${testCase.content.length} å­—ç¬¦`);
        
        const isAI = isAIGeneratedContent(testCase.content);
        console.log(`çµæœ: ${isAI ? 'âœ… æª¢æ¸¬ç‚º AI å…§å®¹' : 'âŒ æœªæª¢æ¸¬ç‚º AI å…§å®¹'}`);
    });
    
    console.log('\nğŸ¯ æ¸¬è©¦å®Œæˆï¼');
}

// æ¸¬è©¦å¯¦éš›çš„æª”æ¡ˆç›£æ§
function testFileMonitoring() {
    console.log('\nğŸ§ª æ¸¬è©¦å¯¦éš›æª”æ¡ˆç›£æ§...\n');
    
    const testDir = 'Tests/monitor_diagnosis/test_files';
    
    // å»ºç«‹æ¸¬è©¦ç›®éŒ„
    if (!fs.existsSync(testDir)) {
        fs.mkdirSync(testDir, { recursive: true });
    }
    
    // å»ºç«‹æ¸¬è©¦æª”æ¡ˆ
    const testFile = path.join(testDir, 'ai_test_file.js');
    const aiContent = `/**
 * AI ç”Ÿæˆçš„æ¸¬è©¦å‡½æ•¸
 * Generated by AI Assistant
 */
function testAIFunction() {
    console.log("é€™æ˜¯ AI ç”Ÿæˆçš„å‡½æ•¸");
    return "AI Generated Content";
}

// ä½¿ç”¨ç¯„ä¾‹
const result = testAIFunction();
console.log(result);`;
    
    console.log(`ğŸ“ å»ºç«‹æ¸¬è©¦æª”æ¡ˆ: ${testFile}`);
    fs.writeFileSync(testFile, aiContent, 'utf8');
    
    console.log('âœ… æ¸¬è©¦æª”æ¡ˆå·²å»ºç«‹');
    console.log('ğŸ’¡ ç¾åœ¨å¯ä»¥å•Ÿå‹•æ”¹é€²çš„ç›£æ§ç³»çµ±ä¾†æ¸¬è©¦æª”æ¡ˆç›£æ§åŠŸèƒ½');
    
    // æ¸…ç†å‡½æ•¸
    setTimeout(() => {
        try {
            fs.unlinkSync(testFile);
            fs.rmdirSync(testDir);
            console.log('ğŸ§¹ æ¸¬è©¦æª”æ¡ˆå·²æ¸…ç†');
        } catch (error) {
            console.error('æ¸…ç†å¤±æ•—:', error.message);
        }
    }, 10000); // 10ç§’å¾Œæ¸…ç†
}

// åŸ·è¡Œæ¸¬è©¦
if (require.main === module) {
    testAIDetection();
    testFileMonitoring();
}

module.exports = { testAIDetection, testFileMonitoring };